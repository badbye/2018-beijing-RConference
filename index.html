<!DOCTYPE html>
<html>
  <head>
    <title>初窥爬虫入门</title>
    <meta charset="utf-8">
    <meta name="author" content="杜亚磊" />
    <meta name="date" content="2018-08-21" />
    <link rel="stylesheet" href="zh-CN.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# 初窥爬虫入门
### 杜亚磊
### 2018-08-21

---





# 主要内容

1. 简介
  - 爬虫是什么？
  - 为什么要学习爬虫？ 
  - 爬虫还可以做什么？

2. 爬虫基础知识
  - 网页: HMTL + CSS + JavaScript
  - 解析: Xpath + CSS选择器 + 正则表达式

3. 豆瓣搜书

4. 真正赚钱的应用
  

---

听完之后，你可以:

- 了解基本的网页知识

- 知道抓取数据的原理



**不能**：

- 立马学会如何抓取数据(除非有编程基础)


---
# 爬虫是什么？

自动地抓取互联网信息的程序或者脚本。

- 谷歌
- 百度
- 今日头条

### 爬虫 与 统计

- 统计是一门`搜集，整理，分析，展示`数据的科学

- 爬虫是搜集数据的一种方式

[比价网](http://www.manmanbuy.com/p_563533.aspx): 搜集各个电商网站在同一款产品的价格，链接，图片等，整合在一起显示出来。

---
class: center, middle, inverse

# 为什么要学习爬虫？

## 悲伤的故事

---

# 爬虫还可以做什么？


自动化搜集数据  &amp; 极速操作

- 领京豆

- 关注贴子的更新，关注房价的变动

- 抢课 + 抢票

- RSS(Really Simple Syndication)订阅

[知乎: 利用爬虫技术能做到哪些很酷很有趣很有用的事情？](https://www.zhihu.com/question/27621722)

注意: 不要[抢月饼]((https://baike.baidu.com/item/%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4%E6%9C%88%E9%A5%BC%E9%97%A8/19961822?fr=aladdin)，不要违反价值观，更不要违法犯纪

---
# 如何爬？

互联网信息，基本都是以网页的形式存在。自动获取信息的步骤：

- 下载网页: 比如下载各个电商平台的某个产品详情页

- 解析网页: 比如从杂乱的网页源代码中，抽出商品的价格

---
class: inverse, middle, center

# 网页基础知识

---

# 网页

一个网页的源代码是包含 HTML, CSS 和 JavaScript 的纯文本。

- HTML: 标记语言。只有语法，没有变量和逻辑，不能称之为~~编程语言~~。

- CSS: 控制元素的展现形式

- JavaScript: 简称JS，操作HTML中元素的增删改

一般来说，数据都是在HTML元素中(否则你看不见它)。

浏览器打开一个链接时，通过HTTP协议拿到网页的源代码，渲染成你看到的样子。


---
# HTML

HTML(Hyper Text Markup Language): 超文本标记语言。用一套标记标签来描述网页。

标签是由尖括号包围的关键词，以下是一些常用的标签:

- `&lt;h1&gt;&lt;/h1&gt;`: 一级标题, 类似标签有h2, h3 ... h6

- `&lt;p&gt;&lt;/p&gt;`: 段落(paragraph)

- `&lt;img&gt;&lt;/img&gt;`: 图片

- `&lt;a&gt;&lt;/a&gt;`: 超链(anchor)

HTML 中的标签数量是固定有限的，不可以自定义。

---

# HTML

- HTML源码:

```html
&lt;html&gt;
  &lt;h1&gt;这是个一级标题&lt;/h1&gt;
  &lt;a id="wth" href="https://www.51talk.com/"&gt;51talk&lt;/a&gt;
&lt;/html&gt;
```


- 效果:

&lt;div style="background:#f8f8f8"&gt;
&lt;h1&gt;这是个一级标题&lt;/h1&gt;
  &lt;a id="wth" href="https://www.51talk.com/"&gt;51talk&lt;/a&gt;
&lt;/div&gt;


.footnote[
学习资料: [HTML 教程](http://www.w3school.com.cn/html/index.asp)
]

---

# HTML DOM

DOM: Document Object Model(文档对象模型)。HTML DOM 是关于如何**获取**、**修改**、**添加**或**删除** HTML 元素的标准。

- DOM 将 HTML 文档视作树结构

- 每个标签是一个节点

- 顶端节点被称为根（root）

- 嵌套的节点有_父子_关系，相邻的节点有_同胞_关系


---

# 查看网页代码

- 你看到的网页片段

![](pic/xiaoshengke.png)

- 对应的源码。在浏览器中，`右键 -&gt; 查看网页源码`。

![](pic/xiaoshengke_source.png)

.footnote[
网页地址: https://movie.douban.com/top250
]

---
# 查看网页代码

豆瓣电影中，史上唯一一部满分电影:

![pic](pic/51moive.png)

---
# 查看网页代码

豆瓣电影中，史上唯一一部满分电影:

![pic](pic/51moive.png)

[打开豆瓣电影 Top 250](https://movie.douban.com/top250) -&gt; "右键"" -&gt; "查看元素" -&gt; 修改元素:

具备了修改网页的能力，你还可以做什么？


---
# CSS

层叠样式表(Cascading Style Sheets)。HTML 定义了内容，CSS 控制展现 形式和样式。

- 页面布局

- 元素位置

- 字体大小

现代的 CSS 3也有包含有动画，元素阴影等效果。

---
# HTML &amp; CSS

通过 CSS 控制字体的颜色和大小:

```html
&lt;html&gt;
  &lt;h1 style="color:blue"&gt;这是个一级标题&lt;/h1&gt;
  &lt;a style="font-size:100px" href="https://www.51talk.com/"&gt;51talk&lt;/a&gt;
&lt;/html&gt;
```


效果:

&lt;div style="background:#f8f8f8"&gt;
&lt;h1 style="color:blue"&gt;这是个一级标题&lt;/h1&gt;
  &lt;a style="font-size:100px" href="https://www.51talk.com/"&gt;51talk&lt;/a&gt;
&lt;/div&gt;

---
# HTML &amp; CSS


```CSS
# my.css
.blue-title{
  color: blue
}
.big_font {
  font-size:100px
}
```

引入外部的 CSS 文件，控制元素展现形式:
```html
&lt;html&gt;
  &lt;link rel="stylesheet" type="text/css" href="my.css"/&gt;
  &lt;h1 class="blue-title"&gt;这是个一级标题&lt;/h1&gt;
  &lt;a class="big_font" href="https://www.51talk.com/"&gt;51talk&lt;/a&gt;
&lt;/html&gt;
```

---

# 下载网页

Python代码:
```python
import requests
doc = requests.get('https://movie.douban.com/top250').content
```


---
# 解析: 想要什么数据

根据豆瓣Top250部电影的数据，回答以下问题：

- 国外的电影比国内的电影受欢迎吗？

- 评价越多的电影，是否评分更高？

- 经典电影 VS 现代大片 


需要搜集: 电影的出产地，评价人数，评分，上映时间。

---
# 解析: XPath

根据 DOM 路径(和属性)查找元素。

```python
import lxml.html
dom = lxml.html.fromstring(doc)  # 解析成DOM

# 使用Xpath拿到所有电影名称
dom.xpath('.//span[@class="title"][1]/text()')
```

```
 [1] "肖申克的救赎"
 [2] "霸王别姬"
 [3] "这个杀手不太冷"
 [4] "阿甘正传"
 ......
```

.footnote[
学习资料: [XPath 教程](http://www.w3school.com.cn/xpath/index.asp)
]


---

# 解析: CSS选择器
根据标签属性选择元素。

```python
[i.text for i in  dom.cssselect('.title')]
```


```
 [1] "肖申克的救赎"
 [2] " / The Shawshank Redemption"
 [3] "这个杀手不太冷"
 [4] " / Léon"
 [5] "霸王别姬"
 [6] "阿甘正传"
 ......
```

.footnote[
学习资料: [CSS 元素选择器](http://www.w3school.com.cn/css/css_selector_type.asp)
]


---

# 解析: 正则

正则表达式(Regular Expression): 描述字符规则的工具，可用于**查找**，**抽取**，**替换**等目的。

例子:

```python
import re
re.search('.*&gt;(.*?)&lt;.*', 
  '&lt;span class="title"&gt;肖生克的救赎&lt;/span&gt;').group(0)
```

- `.` 表示任意字符

- `*` 表示上一个字符的任意数量。 `.*`表示任意长度的任意字符



.footnote[
学习资料:

[1] [正则表达式30分钟入门教程](http://deerchao.net/tutorials/regex/regex.htm)
]


---
# 一段完整的代码

第一页的25部电影名字：

```python
import requests
import lxml.html

doc = requests.get('https://movie.douban.com/top250').content
dom = lxml.html.fromstring(doc)  # 解析成DOM

# 使用Xpath拿到所有电影名称
titles = dom.xpath('.//div[@class="hd"]/a/span[@class="title"][1]/text()')

# 练习: 使用 XPath(或CSS选择器) 抽取电影的导演，评分等信息
# ...
```

---
# 豆瓣电影: 国内 VS 国外

![](pic/douban_china.png)

---
# 豆瓣电影: 现代 &amp; 经典

![](pic/douban_classic.png)


---
# 豆瓣电影: 评价数 &amp; 评分

![](pic/douban_people_score.png)


---
# 豆瓣电影: 评价数 &amp; 评分

![](pic/douban_people_score_v2.png)



---
class: center, middle, inverse

# 一套完整的应用

## [豆瓣搜书]()

---
# 响马读书群

每位群友每月需要读一本书，写一篇书评。否则被会踢出去。

写书评的方法是，按指定格式在群里发言：

&gt; \#读书 《图解http》作者上野宣。很简单的一本书,读http的文档读累了可以读一下,深度不够,有助于不太了解网络原理的人了解一下http以及相关的协议.关于https的章节很有用.

读的书必须是已经出版的，有ISBN(International Standard Book Number)编号。

---
# 读书群需求

- 月底抓取聊天记录，搜集群友的书评，找到谁没有读书

- 提取书评中的书名，在[豆瓣读书](https://book.douban.com/)查找该书

- 提供书评搜索的服务

重点介绍 **豆瓣搜书** 的爬虫功能。


---
# 豆瓣搜书

https://book.douban.com/subject_search?search_text=图解HTTP+上野宣&amp;cat=1001

![](pic/douban_search.png)

---
# 豆瓣搜书

&lt;img src="pic/douban_result.png" height="500px"/&gt;



---
# 书评搜索

.pull-left[
&lt;img src="pic/xiangma_mini.jpeg" height="500px" /&gt;
]

.pull-right[
点进某条记录后, 还会显示：

- 图书的封面
- 图书的作者，豆瓣评分，豆瓣链接
- 该作者还写过哪些书(豆瓣搜索)
- 该群友还读过哪些书
]

---
# 响马月刊

&lt;img src="pic/xiangma_annual.png" height="500px" /&gt;

---
# 个人专辑

&lt;img src="pic/xiangma_people.png" height="500px" /&gt;


---
class: center, middle, inverse
# 赚钱的应用

爬虫的骚操作&lt;sup&gt;*&lt;/sup&gt;，只有想不到，没有做不到

以下内容出自[我收到一份《中国焦虑图鉴》](https://mp.weixin.qq.com/s/K0fUdUWKZdE4dYp8ahjdeg)

---

![](pic/spider_distribution.png)

---
### 出行: 12306

初期靠**倒票**赚钱，现在靠推出**加速/优先抢票服务**来赚钱。

- 智行火车票
- 分流
- 携程
- 飞猪

.pull-left[
&lt;img src="pic/spider_train1.jpeg" height="300px"/&gt;
]

.pull-right[
&lt;img src="pic/spider_train2.png" height="300px"/&gt;
]

---
### 社交：微博

- 僵尸粉
- 广告狗
- 羊毛党

### O2O: 大众点评

- 偷评论
- 刷评论

---
class: center, middle, inverse

## 我们在51talk的尝试

### [reg007.com](reg007.com)

---
class: center, middle

# 提问?

.footnote[
email: [duyalei@51talk.com](mailto:duyalei@51talk.com)
]
    </textarea>
<script src="remark.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
